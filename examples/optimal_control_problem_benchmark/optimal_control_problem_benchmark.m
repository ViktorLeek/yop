%% Optimal Control Problem Benchmark
import yop.*

[t, t0, tf] = yop.time();

w_ice = state('w_ice'); % Engine angular velocity
p_im  = state('p_im');  % Intake manifold pressure
p_em  = state('p_em');  % Exhause manifold pressure
w_tc  = state('w_tc');  % Turbocharger angular velocity
E_gen = state('E_gen'); % Generator energy
x = [w_ice; p_im; p_em; w_tc; E_gen]; % State vector

u_f   = control('u_f');   % Fuel injection per cycle per cylinder
u_wg  = control('u_wg');  % Waste gate control 0-close, 1-fully open
P_gen = control('P_gen'); % Generator power
u = [u_f; u_wg; P_gen]; % Control vector

[dx, y] = genset_model(x, u);

ocpb = ocp('Optimal Control Problem Benchmark');
ocpb.min( int(y.cylinder.fuel_massflow) ); % Minimize total fuel mass
ocpb.st( ...
    ... Problem horizon
    t0 == 0, ...
    1.1 <= tf <= 1.4, ...
    ... Differential constraint
    der(x) == dx, ...
    ... Initial conditions
    w_ice(t0) == rpm2rad(800),... [rad/s]
     p_im(t0) == 1.0143e5    ,... [Pa]
     p_em(t0) == 1.0975e5    ,... [Pa]
     w_tc(t0) == 2.0502e3    ,... [rad/s]
    E_gen(t0) == 0           ,... [J]
    ... Terminal conditions
    E_gen(tf) == 100e3, ... [J]
    P_gen(tf) == 100e3, ... [W]
           dx == 0    , ... stationarity
    ... Box constraints
    rpm2rad(800) <= w_ice <= rpm2rad(2500), ...
    8.1e4 <= p_im  <= 3.5e5 , ...
    9.1e4 <= p_em  <= 4.0e5 , ...
      500 <= w_tc  <= 15e3  , ...
        0 <= E_gen <= 3.0e6 , ...
        0 <= u_f   <= 150   , ...
        0 <= u_wg  <= 1     , ...
        0 <= P_gen <= 100e3 , ...
    ... Path constraints
    y.turbine.BSR_min <= y.turbine.BSR <= y.turbine.BSR_max, ...
    y.engine.power <= y.engine.power_limit, ...
    y.cylinder.fuel_to_air_ratio <= 1/y.cylinder.lambda_min, ...
    y.compressor.pressure_ratio <= y.compressor.surge_line ...
    );
ocpb.build().present();